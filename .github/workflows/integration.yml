# **what?**
# Runs integration tests.

# **why?**
# Ensure code runs as expected.

# **when?**
# This will run for all PRs, when code is pushed to a main branch
# branch, and when manually triggered.

name: Adapter Integration Tests
on:
  workflow_dispatch:
  pull_request:
    branches:
      - "main"
      - "*.latest"
      - "v*"

permissions:
  contents: read
  packages: read

concurrency:
  group: ${{ github.workflow }}-${{ github.event_name }}-${{ github.ref }}
  cancel-in-progress: true

defaults:
  run:
    shell: bash

jobs:
  setup:
    name: Fetch Access Token
    runs-on: ubuntu-latest
    outputs:
      access_token: ${{ steps.fetch_token.outputs.access_token }}
    steps:
      - name: Azure login with OIDC
        uses: azure/login@v2
        with:
          client-id: ${{ secrets.DBT_AZURE_SP_NAME }}
          tenant-id: ${{ secrets.DBT_AZURE_TENANT }}
          allow-no-subscriptions: true
          federated-token: true

      - name: Fetch Access Token
        id: fetch_token
        run: |
          pip install azure-identity pyodbc azure-core

          python - <<EOF
          from azure.core.credentials import AccessToken
          from azure.identity import DefaultAzureCredential
          try:
              credential = DefaultAzureCredential()
              token = credential.get_token("https://analysis.windows.net/powerbi/api/.default")
              print(f"::set-output name=access_token::{token.token}")
          except Exception as e:
              raise RuntimeError(f"Failed to fetch token: {e}")
          EOF

  tests:
    name: Functional Tests
    needs: setup
    runs-on: ubuntu-latest
    strategy:
      matrix:
        test_file:
          - tests/functional/adapter/basic/test_base.py
          - tests/functional/adapter/basic/test_empty.py
          - tests/functional/adapter/basic/test_ephemeral.py
          - tests/functional/adapter/basic/test_generic_tests.py
          - tests/functional/adapter/basic/test_incremental.py
          - tests/functional/adapter/basic/test_singular_tests_ephemeral.py
          - tests/functional/adapter/basic/test_snapshot_check_cols.py
          - tests/functional/adapter/basic/tests_snapshot_timestamp.py

    steps:
      - uses: actions/checkout@v4

      - name: Install dependencies
        run: pip install -r dev_requirements.txt

      - name: Run Functional Test ${{ matrix.test_file }}
        env:
          WORKSPACE_ID: ${{ secrets.WORKSPACE_ID }}
          LAKEHOUSE_ID: ${{ secrets.LAKEHOUSE_ID }}
          LAKEHOUSE_NAME: ${{ secrets.LAKEHOUSE_NAME }}
          SCHEMA_NAME: ${{ secrets.LAKEHOUSE_NAME }}
          CLIENT_ID: ${{ secrets.DBT_AZURE_SP_NAME }}
          TENANT_ID: ${{ secrets.DBT_AZURE_TENANT }}
          FABRIC_INTEGRATION_TESTS_TOKEN: ${{ needs.setup.outputs.access_token }}
        run: pytest -ra -v ${{ matrix.test_file }} --profile "int_tests"
